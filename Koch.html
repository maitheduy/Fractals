<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Weighted Koch IFS Attractor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
            background-color: #f0f0f0;
        }
        #controls {
            margin-top: 20px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px 20px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #controls label {
            text-align: right;
            font-weight: bold;
        }
        #controls input[type="range"] {
            width: 200px;
        }
        #controls input[type="checkbox"] {
            margin-left: 0;
            margin-top: 5px;
        }
        #controls span {
            font-weight: normal;
            text-align: left;
        }
        canvas {
            border: 1px solid #ccc;
            background-color: #f8f8f8;
            margin-top: 20px;
        }
        h1 {
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Advanced Weighted Koch IFS Attractor</h1>
    <div id="controls">
        <label for="wASlider">Trọng số SA:</label>
        <input type="range" id="wASlider" min="0.05" max="0.45" step="0.01" value="0.2">
        <span id="wAValue">0.20</span>
        <label for="wBSlider">Trọng số SM (trên đường thẳng):</label>
        <input type="range" id="wBSlider" min="0.2" max="0.8" step="0.01" value="0.5">
        <span id="wBValue">0.50</span>
        <label for="wCSlider">Trọng số SC:</label>
        <input type="range" id="wCSlider" min="0.55" max="0.95" step="0.01" value="0.8">
        <span id="wCValue">0.80</span>
        <label for="alphaSlider">Chiều cao Apex (alpha):</label>
        <input type="range" id="alphaSlider" min="0" max="2" step="0.01" value="0.8">
        <span id="alphaValue">0.80</span>
        <label for="betaSlider">Góc Apex (beta):</label>
        <input type="range" id="betaSlider" min="-180" max="180" step="1" value="0">
        <span id="betaValue">0°</span>
        <label for="flipApexCheckbox">Lật hướng Apex:</label>
        <input type="checkbox" id="flipApexCheckbox">
        <span></span>
    </div>
    <script>
        let wASlider, wBSlider, wCSlider, alphaSlider, betaSlider, flipApexCheckbox;
        let wAValueSpan, wBValueSpan, wCValueSpan, alphaValueSpan, betaValueSpan;
        let wA, wB, wC, alpha, beta, flipApex;
        let currentPoint;
        let ifs = []; // mỗi phần tử: {fn, prob}
        const numIterations = 80000;

        function setup() {
            let canvas = createCanvas(600, 400);
            canvas.parent(document.body);
            wASlider = select('#wASlider');
            wBSlider = select('#wBSlider');
            wCSlider = select('#wCSlider');
            alphaSlider = select('#alphaSlider');
            betaSlider = select('#betaSlider');
            flipApexCheckbox = select('#flipApexCheckbox');
            wAValueSpan = select('#wAValue');
            wBValueSpan = select('#wBValue');
            wCValueSpan = select('#wCValue');
            alphaValueSpan = select('#alphaValue');
            betaValueSpan = select('#betaValue');
            wASlider.input(updateParams);
            wBSlider.input(updateParams);
            wCSlider.input(updateParams);
            alphaSlider.input(updateParams);
            betaSlider.input(updateParams);
            flipApexCheckbox.changed(updateParams);
            updateParams();
            currentPoint = createVector(0.5, 0.1);
            background(248);
            stroke(0, 80);
            strokeWeight(0.7);
            noLoop();
        }

        function updateParams() {
            wA = parseFloat(wASlider.value());
            wB = parseFloat(wBSlider.value());
            wC = parseFloat(wCSlider.value());
            alpha = parseFloat(alphaSlider.value());
            beta = radians(parseFloat(betaSlider.value()));
            flipApex = flipApexCheckbox.checked();

            if (wA >= wB) { wB = wA + 0.01; wBSlider.value(wB); }
            if (wB >= wC) { wC = wB + 0.01; wCSlider.value(wC); }
            if (wA >= wB) { wA = wB - 0.01; wASlider.value(wA); }
            if (wA < 0.05) { wA = 0.05; wASlider.value(wA); }

            wAValueSpan.html(wA.toFixed(2));
            wBValueSpan.html(wB.toFixed(2));
            wCValueSpan.html(wC.toFixed(2));
            alphaValueSpan.html(alpha.toFixed(2));
            betaValueSpan.html(degrees(beta).toFixed(0) + "°");

            recalculateIFS();
            redraw();
        }

        function recalculateIFS() {
            ifs = [];
            const start = createVector(0, 0);
            const end   = createVector(1, 0);

            const sA = p5.Vector.lerp(start, end, wA);
            const sC = p5.Vector.lerp(start, end, wC);

            const base = p5.Vector.sub(sC, sA);
            const mid  = p5.Vector.lerp(sA, sC, 0.5);
            let up = createVector(0, 1);
            up.rotate(base.heading() + HALF_PI + beta);
            if (flipApex) up.mult(-1);
            up.setMag(alpha * (sqrt(3)/2) * base.mag());
            const sM = p5.Vector.add(mid, up);

            function add(p1, p2) {
                const v = p5.Vector.sub(p2, p1);
                const len = v.mag();
                const ang = v.heading();
                const fn = (p) => {
                    let q = p.copy();
                    q.sub(start);
                    q.rotate(-ang);
                    q.mult(len);
                    q.rotate(ang);
                    q.add(p1);
                    return q;
                };
                ifs.push({fn, prob: len});
            }

            add(start, sA);  // hàm 1
            add(sA,    sM);  // hàm 2
            add(sM,    sC);  // hàm 3
            add(sC,    end); // hàm 4

            const total = ifs.reduce((s,o)=>s+o.prob, 0);
            ifs.forEach(o=>o.prob /= total);
        }

        function draw() {
            background(248);
            translate(0, height);
            scale(1, -1);

            for (let i = 0; i < numIterations; i++) {
                let r = random();
                let cum = 0;
                let chosen;
                for (let o of ifs) {
                    cum += o.prob;
                    if (r <= cum) { chosen = o; break; }
                }
                currentPoint = chosen.fn(currentPoint);
                point(currentPoint.x * width, currentPoint.y * height);
            }
        }
    </script>
</body>
</html>
